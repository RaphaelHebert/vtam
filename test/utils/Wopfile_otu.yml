rule SampleInformation:
    tool: vtam.wrapper.SampleInformation
    input:
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Fasta: vtam.model.Fasta
            PrimerPair: vtam.model.PrimerPair
            TagPair: vtam.model.TagPair
            SampleInformation: vtam.model.SampleInformation
    params:
        fasta_dir: test/utils


rule SortReads:
    tool: vtam.wrapper.SortReads
    input:
        table:
            Fasta: vtam.model.Fasta
            SampleInformation: vtam.model.SampleInformation
            Marker: vtam.model.Marker
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        file:
            sortreads: test/utils/sortreads.tsv
    params:
        min_id: 0.8
        minseqlength: 32
        overhang: 0


rule VariantReadCount:
    tool: vtam.wrapper.VariantReadCount
    input:
        file:
            sortreads: test/utils/sortreads.tsv
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
    output:
        table:
            Variant: vtam.model.Variant
            VariantReadCount: vtam.model.VariantReadCount
    params:
        foo: 0


rule FilterLFN:
    tool: vtam.wrapper.FilterLFN
    input:
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            VariantReadCount: vtam.model.VariantReadCount
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
            threshold_specific: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterLFN: vtam.model.FilterLFN
    params:
        filter_lfn_variant: 1
        lfn_variant_threshold: 0.001
        lfn_variant_replicate_threshold: 0.001
        lfn_biosample_replicate_threshold: 0.001
        lfn_read_count_threshold: 10


rule FilterMinReplicateNumber:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterLFN: vtam.model.FilterLFN
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterMinReplicateNumber: vtam.model.FilterMinReplicateNumber
    params:
        min_replicate_number: 2


rule FilterPCRError:
    tool: vtam.wrapper.FilterPCRError
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterMinReplicateNumber: vtam.model.FilterMinReplicateNumber
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterPCRError: vtam.model.FilterPCRError
    params:
        pcr_error_var_prop: 0.1


rule FilterChimera:
    tool: vtam.wrapper.FilterChimera
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterPCRError: vtam.model.FilterPCRError
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterChimera: vtam.model.FilterChimera
            FilterChimeraBorderline: vtam.model.FilterChimeraBorderline
    params:
        foo: 0


rule FilterRenkonen:
    tool: vtam.wrapper.FilterRenkonen
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterChimera: vtam.model.FilterChimera
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterRenkonen: vtam.model.FilterRenkonen
    params:
        renkonen_threshold: 0.1


rule FilterIndel:
    tool: vtam.wrapper.FilterIndel
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterRenkonen: vtam.model.FilterRenkonen
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterIndel: vtam.model.FilterIndel
    params:
        foo: 0


rule FilterCodonStop:
    tool: vtam.wrapper.FilterCodonStop
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterIndel: vtam.model.FilterIndel
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            FilterCodonStop: vtam.model.FilterCodonStop
    params:
        genetic_table_number: 5


rule ReadCountAverageOverReplicates:
    tool: vtam.wrapper.ReadCountAverageOverReplicates
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterCodonStop: vtam.model.FilterCodonStop
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        table:
            ReadCountAverageOverReplicates: vtam.model.ReadCountAverageOverReplicates
    params:
        foo: 0


rule TaxAssign:
    tool: vtam.wrapper.TaxAssign
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterCodonStop: vtam.model.FilterCodonStop
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
            taxonomy: test/utils/test_wopmars_runner_wopfile_otu.py
            blast_nhr: test/test_files/blastdb/nt.nhr
            blast_nin: test/test_files/blastdb/nt.nin
            blast_nog: test/test_files/blastdb/nt.nog
            blast_nsd: test/test_files/blastdb/nt.nsd
            blast_nsi: test/test_files/blastdb/nt.nsi
            blast_nsq: test/test_files/blastdb/nt.nsq
    output:
        table:
            TaxAssign: vtam.model.TaxAssign
    params:
        identity_threshold: 97
        include_prop: 90
        min_number_of_taxa: 3


rule MakeOtuTable:
    tool: vtam.wrapper.MakeOtuTable
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterChimeraBorderline: vtam.model.FilterChimeraBorderline
            FilterCodonStop: vtam.model.FilterCodonStop
            TaxAssign: vtam.model.TaxAssign
        file:
            fastainfo: test/utils/test_wopmars_runner_wopfile_otu.py
            taxonomy: test/utils/test_wopmars_runner_wopfile_otu.py
    output:
        file:
            OTUTable: test/utils/otutable.tsv
    params:
        foo: 0