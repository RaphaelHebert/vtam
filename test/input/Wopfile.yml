rule Merge:
  tool: vtam.wrapper.Merge
  input:
      file:
          sample2fastq: data/sample2fastq.tsv
  output:
      file:
          fastainfo: data/fastainfo.csv
  params:
      fastq_directory: data/input/fastq
      fasta_dir: data/output/fasta/
      fastq_minovlen: 50
      fastq_maxmergelen: 300
      fastq_minmergelen: 100
      fastq_minlen: 50
      fastq_maxee: 1
      fastq_truncqual: 10
      fastq_maxns: 0
      threads: 8
      fastq_ascii: 33

rule SampleInformation:
    tool: vtam.wrapper.SampleInformation
    input:
        file:
            fastainfo: {{SAMPLE_INFORMATION_TSV}}
    output:
        table:
            File: vtam.model.File
            SampleInformation: vtam.model.SampleInformation
            Marker: vtam.model.Marker
            PrimerPair: vtam.model.PrimerPair
            Biosample: vtam.model.Biosample
            TagPair: vtam.model.TagPair
            Replicate: vtam.model.Replicate
    params:
        fasta_dir: {{FASTA_DIR}}

rule SortReads:
    tool: vtam.wrapper.VariantReadCountDF
    input:
        table:
            File: vtam.model.File
            SampleInformation: vtam.model.SampleInformation
            Marker: vtam.model.Marker
    output:
        file:
            SortReads_sample_counts: {{OUTDIR}}/variant_count_detail.tsv
        table:
            Variant: vtam.model.Variant

    params:
        sort_reads_output_dir: {{OUTDIR}}
        min_id: 0.8
        minseqlength: 32
        overhang: 0


rule Filter:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Marker: vtam.model.Marker
            Variant: vtam.model.Variant
            Replicate: vtam.model.Replicate
        file:
            SortReads_sample_counts: data/sortreads_samplecount.csv
            file_cutoff: data/cutoff_variant.tsv
            genetic_code: data/genetic_codes.csv
    output:
        file:
            marker_variant_path: data/filtered_dataframe_path.tsv
    params:
        lfn_per_replicate_threshold: 0.001
        lfn_per_variant_threshold: 0.001
        lfn_per_replicate_series_threshold: 0.001
        lfn_read_count_threshold: 1
        repeatability_threshold: 2
        pcr_error_var_prop: 0.1
        renkonen_number_of_replicate: 3
        renkonen_renkonen_tail: 0.5



