{% from 'macros.txt' import input_file_threshold_specific, input_lfn_variant_replicate_threshold, rule_taxassign %}{% extends "block_wopfile_asv_optimize.yml" %}
{% block wopfile_asv %}rule FilterLFN:
    tool: vtam.wrapper.FilterLFN
    input:
        table:
            Run: vtam.models.Run
            Marker: vtam.models.Marker
            Biosample: vtam.models.Biosample
            VariantReadCount: vtam.models.VariantReadCount
        file:
            fastainfo: {{fastainfo}}{{ input_file_threshold_specific(threshold_specific) }}
    output:
        table:
            FilterLFN: vtam.models.FilterLFN
    params:{{ input_lfn_variant_replicate_threshold(lfn_variant_threshold, lfn_variant_replicate_threshold) }}
        lfn_biosample_replicate_threshold: {{lfn_biosample_replicate_threshold}}
        lfn_read_count_threshold: {{lfn_read_count_threshold}}


rule FilterMinReplicateNumber:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Run: vtam.models.Run
            Marker: vtam.models.Marker
            Biosample: vtam.models.Biosample
            FilterLFN: vtam.models.FilterLFN
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterMinReplicateNumber: vtam.models.FilterMinReplicateNumber
    params:
        input_filter_lfn: 1
        min_replicate_number: {{min_replicate_number}}


rule FilterPCRerror:
    tool: vtam.wrapper.FilterPCRerror
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            Variant: vtam.models.Variant
            FilterMinReplicateNumber: vtam.models.FilterMinReplicateNumber
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterPCRerror: vtam.models.FilterPCRerror
    params:
        pcr_error_var_prop: {{pcr_error_var_prop}}


rule FilterChimera:
    tool: vtam.wrapper.FilterChimera
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            Variant: vtam.models.Variant
            FilterPCRerror: vtam.models.FilterPCRerror
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterChimera: vtam.models.FilterChimera
            FilterChimeraBorderline: vtam.models.FilterChimeraBorderline


rule FilterMinReplicateNumber2:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Run: vtam.models.Run
            Marker: vtam.models.Marker
            Biosample: vtam.models.Biosample
            FilterLFN: vtam.models.FilterChimera
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterMinReplicateNumber: vtam.models.FilterMinReplicateNumber2
    params:
        input_filter_lfn: 0
        min_replicate_number: {{min_replicate_number}}


rule FilterRenkonen:
    tool: vtam.wrapper.FilterRenkonen
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            FilterChimera: vtam.models.FilterMinReplicateNumber2
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterRenkonen: vtam.models.FilterRenkonen
    params:
        upper_renkonen_tail: {{upper_renkonen_tail}}


rule FilterMinReplicateNumber3:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Run: vtam.models.Run
            Marker: vtam.models.Marker
            Biosample: vtam.models.Biosample
            FilterLFN: vtam.models.FilterRenkonen
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterMinReplicateNumber: vtam.models.FilterMinReplicateNumber3
    params:
        input_filter_lfn: 0
        min_replicate_number: {{min_replicate_number}}


rule FilterIndel:
    tool: vtam.wrapper.FilterIndel
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            Variant: vtam.models.Variant
            FilterRenkonen: vtam.models.FilterMinReplicateNumber3
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterIndel: vtam.models.FilterIndel
    params:
        skip_filter_indel: {{skip_filter_indel}}


rule FilterCodonStop:
    tool: vtam.wrapper.FilterCodonStop
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            Variant: vtam.models.Variant
            FilterIndel: vtam.models.FilterIndel
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterCodonStop: vtam.models.FilterCodonStop
    params:
        genetic_table_number: {{genetic_table_number}}
        skip_filter_codon_stop: {{skip_filter_codon_stop}}


rule ReadCountAverageOverReplicates:
    tool: vtam.wrapper.ReadCountAverageOverReplicates
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            FilterCodonStop: vtam.models.FilterCodonStop
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            ReadCountAverageOverReplicates: vtam.models.ReadCountAverageOverReplicates


{{ rule_taxassign(fastainfo, taxonomy, update_taxassign, ltg_rule_threshold, include_prop, min_number_of_taxa, blast_db) }}


rule MakeAsvTable:
    tool: vtam.wrapper.MakeAsvTable
    input:
        table:
            Marker: vtam.models.Marker
            Run: vtam.models.Run
            Biosample: vtam.models.Biosample
            Variant: vtam.models.Variant
            FilterChimeraBorderline: vtam.models.FilterChimeraBorderline
            FilterCodonStop: vtam.models.FilterCodonStop
            TaxAssign: vtam.models.TaxAssign
        file:
            fastainfo: {{fastainfo}}
            taxonomy: {{taxonomy}}
    output:
        file:
            ASVTable: {{asvtable}}{% endblock %}