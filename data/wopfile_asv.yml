{% from 'macros.txt' import param_log, rule_filter_lfn, param_map_taxids, input_file_threshold_specific %}{% extends "block_wopfile_asv_optimize.yml" %}
{% block wopfile_asv %}rule FilterLFN:
    tool: vtam.wrapper.FilterLFN
    input:
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            VariantReadCount: vtam.model.VariantReadCount
        file:
            fastainfo: {{fastainfo}}{{ input_file_threshold_specific(threshold_specific) }}
    output:
        table:
            FilterLFN: vtam.model.FilterLFN
    params:
        filter_lfn_variant: {{filter_lfn_variant}}
        lfn_variant_threshold: {{lfn_variant_threshold}}
        lfn_variant_replicate_threshold: {{lfn_variant_replicate_threshold}}
        lfn_biosample_replicate_threshold: {{lfn_biosample_replicate_threshold}}
        lfn_read_count_threshold: {{lfn_read_count_threshold}}


rule FilterMinReplicateNumber:
    tool: vtam.wrapper.FilterMinReplicateNumber
    input:
        table:
            Run: vtam.model.Run
            Marker: vtam.model.Marker
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterLFN: vtam.model.FilterLFN
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterMinReplicateNumber: vtam.model.FilterMinReplicateNumber
    params:
        min_replicate_number: {{min_replicate_number}}


rule FilterPCRerror:
    tool: vtam.wrapper.FilterPCRerror
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterMinReplicateNumber: vtam.model.FilterMinReplicateNumber
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterPCRerror: vtam.model.FilterPCRerror
    params:
        pcr_error_var_prop: {{pcr_error_var_prop}}


rule FilterChimera:
    tool: vtam.wrapper.FilterChimera
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterPCRerror: vtam.model.FilterPCRerror
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterChimera: vtam.model.FilterChimera
            FilterChimeraBorderline: vtam.model.FilterChimeraBorderline


rule FilterRenkonen:
    tool: vtam.wrapper.FilterRenkonen
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterChimera: vtam.model.FilterChimera
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterRenkonen: vtam.model.FilterRenkonen
    params:
        renkonen_threshold: {{renkonen_threshold}}


rule FilterIndel:
    tool: vtam.wrapper.FilterIndel
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterRenkonen: vtam.model.FilterRenkonen
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterIndel: vtam.model.FilterIndel


rule FilterCodonStop:
    tool: vtam.wrapper.FilterCodonStop
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterIndel: vtam.model.FilterIndel
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            FilterCodonStop: vtam.model.FilterCodonStop
    params:
        genetic_table_number: {{genetic_table_number}}


rule ReadCountAverageOverReplicates:
    tool: vtam.wrapper.ReadCountAverageOverReplicates
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            FilterCodonStop: vtam.model.FilterCodonStop
        file:
            fastainfo: {{fastainfo}}
    output:
        table:
            ReadCountAverageOverReplicates: vtam.model.ReadCountAverageOverReplicates


rule TaxAssign:
    tool: vtam.wrapper.TaxAssign
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterCodonStop: vtam.model.FilterCodonStop
        file:
            fastainfo: {{fastainfo}}
            taxonomy: {{taxonomy}}
    output:
        table:
            TaxAssign: vtam.model.TaxAssign
    params:
        ltg_rule_threshold: {{ltg_rule_threshold}}
        include_prop: {{include_prop}}
        min_number_of_taxa: {{min_number_of_taxa}}
        blast_db: {{blast_db}}


rule MakeAsvTable:
    tool: vtam.wrapper.MakeAsvTable
    input:
        table:
            Marker: vtam.model.Marker
            Run: vtam.model.Run
            Biosample: vtam.model.Biosample
            Replicate: vtam.model.Replicate
            Variant: vtam.model.Variant
            FilterChimeraBorderline: vtam.model.FilterChimeraBorderline
            FilterCodonStop: vtam.model.FilterCodonStop
            TaxAssign: vtam.model.TaxAssign
        file:
            fastainfo: {{fastainfo}}
            taxonomy: {{taxonomy}}
    output:
        file:
            ASVTable: {{asvtable}}


rule PoolMarkers:
    tool: vtam.wrapper.PoolMarkers
    input:
        file:
            ASVtable: {{asvtable}}
    output:
        file:
            PooledMarkers: {{pooled_markers}}{% endblock %}